import { test, expect } from '@playwright/test';

/**
 * THE BEAST TEST SUITE - PHASE 3: REAL WORLD EXPLOITS
 */

test.describe('Security Exploit Scenarios', () => {

  test('Exploit: Direct Access to Tenant Settings (Unauthorized)', async ({ page }) => {
    // A user logs in, but tries to access /tenant/settings for another studio.
    // Since we don't have multiple logins in this test yet, we'll verify
    // that accessing it without a session redirects to login.
    await page.goto('/tenant/settings');
    expect(page.url()).toContain('/login');
  });

  test('Exploit: API Data Harvesting (Bookings)', async ({ page }) => {
    // Attempt to hit the calendar feed which often has less protection
    const response = await page.goto('/api/calendar/feed/malicious-secret');
    
    // It should NOT return 200 with data. It should be 404 or 401.
    expect(response?.status()).not.toBe(200);
  });

  test('Exploit: Dropbox Proxy Abuse', async ({ page }) => {
    // Attempt to use our Dropbox proxy to fetch a file outside of the /Production/ root
    // by using path traversal characters.
    const response = await page.goto('/api/dropbox/assets/any-id?path=../../etc/passwd');
    
    // Our "Path Traversal Guard" should catch this.
    expect(response?.status()).toBe(400);
  });

  test('Exploit: PDF Generation Parameter Injection', async ({ page }) => {
    // Attempt to inject a massive tenantId into the PDF route
    const longId = 'a'.repeat(1000);
    const response = await page.goto(`/api/tenant/${longId}/invoices/any-id/pdf`);
    
    // Should fail gracefully, not crash the server
    expect(response?.status()).not.toBe(500);
  });
});

